<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Disponibilidad | El Mariachi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--primary:#d32f2f;--hover:#b71c1c;--light:#f5f5f5;--text:#212121;--muted:#757575;--border:#e0e0e0;--success:#4caf50}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--light);color:var(--text);font-family:Segoe UI,Roboto,Arial;padding-bottom:40px}
    .navbar{background:linear-gradient(135deg,var(--primary),var(--hover))}
    .navbar-brand{color:#fff;font-weight:800}
    .container{max-width:1200px}
    h1{color:var(--text);font-weight:700;font-size:28px;margin-bottom:24px}
    .menu-links{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
    .menu-btn{padding:10px 16px;border:2px solid var(--border);background:#fff;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.3s;color:var(--text);text-decoration:none;display:inline-block}
    .menu-btn:hover{border-color:var(--primary);background:rgba(211,47,47,0.05)}
    .menu-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .card{border-radius:12px;border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .item-row{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .item-row:last-child{border-bottom:none}
    .item-info{display:flex;flex-direction:column;gap:4px}
    .item-name{font-weight:700;color:var(--text);font-size:14px}
    .item-status{color:var(--muted);font-size:12px}
    .toggle-switch{position:relative;display:inline-block;width:50px;height:28px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:0.3s;border-radius:28px}
    .toggle-slider:before{position:absolute;content:'';height:22px;width:22px;left:3px;bottom:3px;background-color:#fff;transition:0.3s;border-radius:50%}
    input:checked+.toggle-slider{background-color:var(--success)}
    input:checked+.toggle-slider:before{transform:translateX(22px)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:20px}
    @media(max-width:768px){.grid{grid-template-columns:1fr}.menu-links{flex-direction:column}}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <a class="navbar-brand" href="B-19PanelAdmin.html">üåÆ El Mariachi ‚Ä¢ Admin</a>
      <a class="btn btn-outline-light btn-sm" href="B-09ConstruccionPedido.html">‚Üê Salir Admin</a>
    </div>
  </nav>

  <div class="container my-5">
    <h1>Gesti√≥n de Disponibilidad</h1>

    <div class="menu-links">
      <a href="B-19PanelAdmin.html" class="menu-btn">üì¶ Productos</a>
      <a href="B-20TogglesdeDisponibilidad.html" class="menu-btn active">‚úì Disponibilidad</a>
      <a href="B-21CargadeImagenes.html" class="menu-btn">üì∏ Im√°genes</a>
      <a href="B-22Dashboard.html" class="menu-btn">üìä Dashboard</a>
      <a href="B-23GestionVisual.html" class="menu-btn">üë• Usuarios</a>
      <a href="B-24IndicadoresdeValidacion.html" class="menu-btn">‚úî Validaciones</a>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Vista Cliente (Cat√°logo)</h5>
          <div id="catalogList"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Control Admin</h5>
          <div id="adminList"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Verificar sesi√≥n admin
  (function(){
    const session = JSON.parse(localStorage.getItem('adminSession') || 'null');
    if(!session || session.role !== 'admin'){
      window.location.href = 'B-01LoginAdmin.html';
    }
  })();

  const API_URL = "http://localhost:4000/graphql";
  let products = [];

  async function fetchProducts(){
    const q = `query { productos { id_producto nombre precio disponible categoria } }`;
    const session = JSON.parse(localStorage.getItem('adminSession') || '{}');
    const headers = { 'Content-Type': 'application/json' };
    if (session.token) headers['Authorization'] = `Bearer ${session.token}`;

    try {
      const res = await fetch(API_URL, { method:'POST', headers, body: JSON.stringify({query:q}) });
      const json = await res.json();
      products = (json.data?.productos || []).map(p => ({
        id: String(p.id_producto),
        nombre: p.nombre,
        precio: Number(p.precio)||0,
        disponible: !!p.disponible,
        categoria: p.categoria||'Sin cat'
      }));
      renderBoth();
    } catch(err){
      console.error(err);
      document.getElementById('catalogList').innerHTML = '<div style="color:var(--muted);padding:16px">Error cargando productos</div>';
    }
  }

  async function toggleProduct(id) {
    const p = products.find(x => x.id === id);
    if (!p) return;

    const session = JSON.parse(localStorage.getItem('adminSession') || '{}');
    const headers = { 'Content-Type': 'application/json' };
    if (session.token) headers['Authorization'] = `Bearer ${session.token}`;

    // Usar la mutation exacta del servidor
    const mutation = `mutation {
      actualizar_disponibilidad_producto(
        id_producto: ${id}
        disponible: ${!p.disponible}
      ) {
        ok
        mensaje
        producto {
          id_producto
          disponible
        }
      }
    }`;

    try {
      const res = await fetch(API_URL, { method:'POST', headers, body: JSON.stringify({query:mutation}) });
      const json = await res.json();

      if(json.errors) {
        console.error('Toggle error:', json.errors);
        alert('Error al actualizar: ' + json.errors[0]?.message);
        return;
      }

      const result = json.data?.actualizar_disponibilidad_producto;
      if (result?.ok) {
        p.disponible = !p.disponible;
        renderBoth();
        localStorage.setItem('productsUpdated', String(Date.now())); // notificar B-09
        console.log('‚úì Disponibilidad actualizada');
      } else {
        alert('Error: ' + (result?.mensaje || 'respuesta inesperada'));
      }
    } catch(err) {
      console.error(err);
      alert('Error de red');
    }
  }

  function renderBoth(){
    const catalog = document.getElementById('catalogList');
    const admin = document.getElementById('adminList');
    
    catalog.innerHTML = products.map(p => `
      <div class="item-row">
        <div class="item-info">
          <div class="item-name">${p.nombre}</div>
          <div class="item-status">${p.disponible ? '‚úì Disponible' : '‚úó No disponible'}</div>
        </div>
        <button class="btn btn-sm ${p.disponible ? 'btn-primary' : 'btn-secondary'}" ${!p.disponible ? 'disabled' : ''}>Agregar</button>
      </div>
    `).join('');

    admin.innerHTML = products.map(p => `
      <div class="item-row">
        <div class="item-info">
          <div class="item-name">${p.nombre}</div>
          <div class="item-status">$${p.precio.toLocaleString()}</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" ${p.disponible ? 'checked' : ''} onchange="toggleProduct('${p.id}')" />
          <span class="toggle-slider"></span>
        </label>
      </div>
    `).join('');
  }

  // Escuchar cambios desde B-19
  window.addEventListener('storage', (e) => {
    if (e.key === 'productsUpdated') {
      console.log('Admin actualiz√≥ productos en B-20');
      fetchProducts();
    }
  });

  // Inicializar
  fetchProducts();
</script>
</body>
</html>




