<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Ä¢ Panel Control | El Mariachi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#d32f2f;
      --accent:#ff6f00;
      --dark:#1a1a1a;
      --light:#f5f5f5;
      --text:#212121;
      --muted:#757575;
      --border:#e0e0e0;
      --success:#4caf50;
      --hover:#b71c1c;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--light);color:var(--text);padding-bottom:40px}
    .navbar{background:linear-gradient(135deg,var(--primary),var(--hover))}
    .navbar-brand{color:#fff;font-weight:800;font-size:20px}
    .card{border-radius:12px;border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .container{max-width:1200px}
    .menu-tabs{display:flex;gap:8px;margin-bottom:28px;flex-wrap:wrap;padding:16px;background:#fff;border-radius:12px;border:1px solid var(--border)}
    .menu-tab{padding:10px 16px;border:2px solid var(--border);background:#fff;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.3s;color:var(--text);text-decoration:none;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .menu-tab:hover{border-color:var(--primary);background:rgba(211,47,47,0.05)}
    .menu-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .search-input{border:2px solid var(--border);border-radius:8px;padding:10px 12px;flex:1;min-width:250px}
    .btn-dark{background:var(--dark);border:none;color:#fff;font-weight:600}
    .btn-dark:hover{background:#000;color:#fff}
    .btn-outline-dark{border:2px solid var(--dark);color:var(--dark);background:#fff;font-weight:600;transition:all 0.3s}
    .btn-outline-dark:hover{background:var(--dark);color:#fff}
    .table thead th{border-bottom:2px solid var(--border);font-weight:700;color:var(--text);background:#f9f9f9}
    .table tbody td{border-bottom:1px solid var(--border);vertical-align:middle}
    .status-chip{padding:6px 10px;border-radius:12px;font-weight:700;font-size:12px;display:inline-block}
    .chip-active{background:rgba(76,175,80,0.12);color:var(--success);border:1px solid rgba(76,175,80,0.2)}
    .chip-inactive{background:rgba(220,53,69,0.06);color:#c62828;border:1px solid rgba(220,53,69,0.12)}
    .small-muted{color:var(--muted);font-size:13px}
    .form-inline{gap:12px;display:flex;align-items:center;flex-wrap:wrap;margin-bottom:20px}
    .search-container{flex:1;min-width:250px}
    .btn-group{display:flex;gap:8px}
    @media(max-width:768px){
      .menu-tabs{flex-direction:column}
      .menu-tab{width:100%}
      .form-inline{flex-direction:column;align-items:stretch}
      .search-container{min-width:100%}
      .btn-group{flex-direction:column}
      .btn-group button{width:100%}
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <a class="navbar-brand" href="B-19PanelAdmin.html">üåÆ El Mariachi ‚Ä¢ Admin</a>
      <div class="d-flex gap-2">
        <a class="btn btn-light btn-sm" href="B-12HistorialPedidos.html">Pedidos</a>
        <a class="btn btn-light btn-sm" href="B-09ConstruccionPedido.html">‚Üê Ver tienda</a>
        <button id="logoutBtn" class="btn btn-outline-light btn-sm">üö™ Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <!-- Menu de navegaci√≥n -->
    <div class="menu-tabs">
      <a href="B-19PanelAdmin.html" class="menu-tab active">
        <span>üì¶</span> Productos
      </a>
      <a href="B-20TogglesdeDisponibilidad.html" class="menu-tab">
        <span>‚úì</span> Disponibilidad
      </a>
      <a href="B-21CargadeImagenes.html" class="menu-tab">
        <span>üì∏</span> Im√°genes
      </a>
      <a href="B-22Dashboard.html" class="menu-tab">
        <span>üìä</span> Dashboard
      </a>
      <a href="B-23GestionVisual.html" class="menu-tab">
        <span>üë•</span> Usuarios
      </a>
      <a href="B-24IndicadoresdeValidacion.html" class="menu-tab">
        <span>‚úì</span> Validaciones
      </a>
    </div>

    <!-- Panel de Productos -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">Gesti√≥n de Productos</h4>
          <div class="small-muted">Conectado a: http://localhost:4000/graphql</div>
        </div>

        <div class="form-inline">
          <div class="search-container">
            <input id="searchInput" class="search-input w-100" placeholder="Buscar producto (nombre, categor√≠a)..." />
          </div>
          <div class="btn-group">
            <button id="refreshBtn" class="btn btn-dark">üîÑ Actualizar</button>
            <button id="newBtn" class="btn btn-dark">‚ûï Nuevo Producto</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Nombre</th>
                <th style="width:120px">Precio</th>
                <th>Categor√≠a</th>
                <th>Disponible</th>
                <th style="width:180px">Acciones</th>
              </tr>
            </thead>
            <tbody id="productsTbody">
              <tr><td colspan="5" class="small-muted text-center py-4">Cargando productos...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Editor de productos -->
        <div class="collapse mt-4" id="editorCard">
          <div class="card card-body border-dark">
            <h5 class="fw-bold mb-3" id="editorTitle">Editar Producto</h5>
            <form id="productForm" class="row g-3">
              <input type="hidden" id="pId">
              <div class="col-md-6">
                <label class="form-label fw-600">Nombre</label>
                <input id="pNombre" class="form-control" placeholder="Nombre del producto" required>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-600">Precio</label>
                <input id="pPrecio" class="form-control" type="number" min="0" placeholder="0" required>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-600">Categor√≠a</label>
                <input id="pCategoria" class="form-control" placeholder="Ej: Tacos">
              </div>
              <div class="col-12">
                <label class="form-label fw-600">Descripci√≥n</label>
                <textarea id="pDescripcion" class="form-control" rows="2" placeholder="Descripci√≥n breve..."></textarea>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-600">Disponible</label>
                <select id="pDisponible" class="form-select">
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="col-md-9 d-flex gap-2 align-items-end">
                <button type="submit" class="btn btn-dark">üíæ Guardar</button>
                <button type="button" class="btn btn-outline-dark" id="cancelEdit">Cancelar</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = 'http://localhost:4000/graphql';
  window.products = [];

  // Verificar sesi√≥n admin
  (function(){
    const session = JSON.parse(localStorage.getItem('adminSession') || 'null');
    if(!session || session.role !== 'admin'){
      window.location.href = 'B-01LoginAdmin.html';
    }
  })();

  // === CARGAR PRODUCTOS ===
  async function fetchProducts() {
    const tbody = document.getElementById('productsTbody');
    if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Cargando productos...</td></tr>`;

    const session = JSON.parse(localStorage.getItem('adminSession') || '{}');
    const headers = { 'Content-Type': 'application/json' };
    if (session.token) headers['Authorization'] = `Bearer ${session.token}`;

    const query = `query {
      productos {
        id_producto
        nombre
        precio
        categoria
        descripcion
        disponible
      }
    }`;

    try {
      const res = await fetch(API_URL, { method: 'POST', headers, body: JSON.stringify({ query }) });
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch (e) { json = null; }

      if (!res.ok || !json || json.errors) {
        console.error('fetchProducts error:', json?.errors || text);
        if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Error al cargar productos (ver consola).</td></tr>`;
        return;
      }

      const data = json.data?.productos || [];
      window.products = data.map(it => ({
        id: it.id_producto ?? it._id ?? it.id,
        id_producto: it.id_producto ?? it._id ?? it.id,
        nombre: it.nombre ?? it.name ?? '',
        precio: Number(it.precio ?? it.price ?? 0),
        categoria: it.categoria ?? it.category ?? '',
        descripcion: it.descripcion ?? it.description ?? '',
        disponible: typeof it.disponible !== 'undefined' ? !!it.disponible : true
      }));

      console.log(`Cargados ${window.products.length} productos.`);
      renderTable();
    } catch (err) {
      console.error('fetchProducts exception:', err);
      if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Error de red (ver consola).</td></tr>`;
    }
  }

  // === RENDERIZAR TABLA ===
  function renderTable(){
    const q = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
    const filtered = window.products.filter(p => 
      !q || (p.nombre||'').toLowerCase().includes(q) || (p.categoria||'').toLowerCase().includes(q)
    );

    const tbody = document.getElementById('productsTbody');
    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" class="small-muted text-center py-4">Sin resultados</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(p => `
      <tr>
        <td>
          <div style="font-weight:700">${p.nombre}</div>
          <div class="small-muted">${(p.descripcion || '').substring(0,60)}...</div>
        </td>
        <td>$${p.precio.toLocaleString()}</td>
        <td><span class="small-muted">${p.categoria}</span></td>
        <td>${p.disponible ? '<span class="status-chip chip-active">‚úì Disponible</span>' : '<span class="status-chip chip-inactive">‚úó Agotado</span>'}</td>
        <td>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-dark" onclick="editProduct('${p.id}')">‚úè Editar</button>
            <button class="btn btn-sm btn-dark" onclick="toggleAvailability('${p.id}')">${p.disponible ? 'üîí Ocultar' : 'üîì Publicar'}</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  // === EDITAR PRODUCTO ===
  function editProduct(id){
    const p = window.products.find(x => x.id === id);
    if(!p) return;
    document.getElementById('pId').value = p.id;
    document.getElementById('pNombre').value = p.nombre;
    document.getElementById('pPrecio').value = p.precio;
    document.getElementById('pCategoria').value = p.categoria;
    document.getElementById('pDescripcion').value = p.descripcion;
    document.getElementById('pDisponible').value = p.disponible ? 'true' : 'false';
    document.getElementById('editorTitle').textContent = `‚úè Editar: ${p.nombre}`;
    new bootstrap.Collapse(document.getElementById('editorCard'), { toggle: true });
  }

  // === NUEVO PRODUCTO ===
  document.getElementById('newBtn')?.addEventListener('click', () => {
    document.getElementById('pId').value = '';
    document.getElementById('pNombre').value = '';
    document.getElementById('pPrecio').value = '';
    document.getElementById('pCategoria').value = '';
    document.getElementById('pDescripcion').value = '';
    document.getElementById('pDisponible').value = 'true';
    document.getElementById('editorTitle').textContent = '‚ûï Nuevo Producto';
    new bootstrap.Collapse(document.getElementById('editorCard'), { toggle: true });
  });

  document.getElementById('cancelEdit')?.addEventListener('click', () => {
    new bootstrap.Collapse(document.getElementById('editorCard'), { toggle: false });
  });

  // === BUSCAR ===
  document.getElementById('searchInput')?.addEventListener('input', () => renderTable());
  document.getElementById('refreshBtn')?.addEventListener('click', () => fetchProducts());

  // === GUARDAR PRODUCTO ===
  document.getElementById('productForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('pId').value.trim();
    const nombre = document.getElementById('pNombre').value.trim();
    const precio = Number(document.getElementById('pPrecio').value) || 0;
    const categoria = document.getElementById('pCategoria').value.trim() || 'Sin categor√≠a';
    const descripcion = document.getElementById('pDescripcion').value.trim() || '';
    const disponible = document.getElementById('pDisponible').value === 'true';

    if(!nombre || precio < 0) return alert('Completa nombre y precio v√°lido');

    const session = JSON.parse(localStorage.getItem('adminSession') || '{}');
    const headers = { 'Content-Type': 'application/json' };
    if (session.token) headers['Authorization'] = `Bearer ${session.token}`;

    // Seleccionar mutation seg√∫n si es crear o actualizar
    const isUpdate = !!id;
    let mutation = '';

    if (isUpdate) {
      // Asumir que la mutation de actualizar es similar a crear pero con id
      mutation = `mutation {
        actualizar_disponibilidad_producto(
          id_producto: ${id}
          disponible: ${disponible}
        ) {
          ok
          mensaje
          producto { id_producto nombre disponible }
        }
      }`;
    } else {
      // Para crear, intenta una mutation est√°ndar (ajusta nombre si es diferente)
      // Intenta varios nombres comunes
      mutation = `mutation {
        crear_producto(
          nombre: "${nombre.replace(/"/g, '\\"')}"
          precio: ${precio}
          categoria: "${categoria.replace(/"/g, '\\"')}"
          descripcion: "${descripcion.replace(/"/g, '\\"')}"
          disponible: ${disponible}
        ) {
          ok
          mensaje
          producto { id_producto nombre disponible }
        }
      }`;
    }

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify({ query: mutation })
      });
      const json = await res.json();

      if(json.errors) {
        console.error('Mutation error:', json.errors);
        alert('Error: ' + json.errors[0]?.message);
        return;
      }

      alert('‚úì Producto ' + (isUpdate ? 'actualizado' : 'creado') + ' correctamente');
      localStorage.setItem('productsUpdated', String(Date.now())); // notificar B-09
      await fetchProducts();
      new bootstrap.Collapse(document.getElementById('editorCard'), { toggle: false });
    } catch(err) {
      console.error('Save error:', err);
      alert('Error de red al guardar producto.');
    }
  });

  // === TOGGLE DISPONIBILIDAD ===
  window.toggleAvailability = async function(productId) {
    const p = window.products.find(x => String(x.id) === String(productId));
    if (!p) return alert('Producto no encontrado.');

    const nuevo = !p.disponible;
    const session = JSON.parse(localStorage.getItem('adminSession') || '{}');
    const headers = { 'Content-Type': 'application/json' };
    if (session.token) headers['Authorization'] = `Bearer ${session.token}`;

    // Usar la mutation exacta del servidor
    const mutation = `mutation {
      actualizar_disponibilidad_producto(
        id_producto: ${productId}
        disponible: ${nuevo}
      ) {
        ok
        mensaje
        producto {
          id_producto
          nombre
          disponible
        }
      }
    }`;

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify({ query: mutation })
      });
      const json = await res.json();

      if(json.errors) {
        console.error('Toggle error:', json.errors);
        alert('Error al actualizar: ' + json.errors[0]?.message);
        return;
      }

      const result = json.data?.actualizar_disponibilidad_producto;
      if (result?.ok && result?.producto) {
        p.disponible = !!result.producto.disponible;
        renderTable();
        localStorage.setItem('productsUpdated', String(Date.now())); // notificar B-09
        console.log('‚úì Disponibilidad actualizada:', result.mensaje);
      } else {
        alert('Error: ' + (result?.mensaje || 'respuesta inesperada'));
      }
    } catch(err) {
      console.error('Toggle exception:', err);
      alert('Error de red al actualizar disponibilidad.');
    }
  };

  // === LOGOUT ===
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminSession');
    window.location.href = 'B-01LoginAdmin.html';
  });

  // === INICIALIZAR ===
  document.addEventListener('DOMContentLoaded', () => {
    fetchProducts();
  });
</script>
</body>
</html>
