<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Boleta Digital ‚Ä¢ El Mariachi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#d32f2f;
      --secondary:#ffc107;
      --accent:#ff6f00;
      --dark:#1a1a1a;
      --light:#f5f5f5;
      --text-dark:#212121;
      --text-light:#757575;
      --border:#e0e0e0;
      --success:#4caf50;
      --hover:#b71c1c
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      background:var(--light);
      color:var(--text-dark);
      font-family:'Segoe UI',Roboto,'Helvetica Neue',sans-serif;
      line-height:1.6
    }
    header{
      background:linear-gradient(135deg,var(--primary),var(--hover));
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 0;
      position:sticky;
      top:0;
      z-index:100
    }
    .navbar-brand{
      color:#fff!important;
      font-weight:700;
      font-size:24px;
      letter-spacing:-0.5px
    }
    .back-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#fff;
      text-decoration:none;
      font-weight:600;
      padding:8px 12px;
      border-radius:8px;
      transition:all 0.3s;
      background:rgba(255,255,255,0.1)
    }
    .back-btn:hover{
      background:rgba(255,255,255,0.2);
      transform:translateX(-4px);
      color:#fff
    }
    .container{
      max-width:1000px;
      padding:40px 24px
    }
    h1{
      color:var(--text-dark);
      font-weight:700;
      font-size:32px;
      margin-bottom:32px;
      letter-spacing:-0.5px
    }
    .receipt-grid{
      display:grid;
      grid-template-columns:1fr 380px;
      gap:32px;
      align-items:start
    }
    .receipt-document{
      background:#fff;
      border-radius:12px;
      border:1px solid var(--border);
      padding:40px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      font-size:13px;
      line-height:1.8
    }
    .receipt-header{
      text-align:center;
      border-bottom:2px solid var(--primary);
      padding-bottom:20px;
      margin-bottom:24px
    }
    .receipt-logo{
      font-size:32px;
      margin-bottom:8px
    }
    .receipt-title{
      color:var(--text-dark);
      font-weight:700;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:1px;
      margin-bottom:4px
    }
    .receipt-subtitle{
      color:var(--text-light);
      font-size:12px;
      margin-bottom:12px
    }
    .receipt-info{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-bottom:24px;
      padding:16px;
      background:rgba(211,47,47,0.02);
      border-radius:8px
    }
    .info-item{
      display:flex;
      flex-direction:column;
      gap:4px
    }
    .info-label{
      color:var(--text-light);
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px
    }
    .info-value{
      color:var(--text-dark);
      font-weight:700;
      font-size:13px
    }
    .receipt-items{
      margin:24px 0;
      padding:20px 0;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border)
    }
    .receipt-item-row{
      display:grid;
      grid-template-columns:1fr auto;
      gap:12px;
      padding:12px 0;
      font-size:12px;
      align-items:center
    }
    .item-desc{
      display:flex;
      flex-direction:column;
      gap:2px
    }
    .item-name{
      color:var(--text-dark);
      font-weight:600
    }
    .item-qty{
      color:var(--text-light);
      font-size:11px
    }
    .item-price{
      color:var(--primary);
      font-weight:700;
      text-align:right
    }
    .receipt-summary{
      margin-top:24px;
      display:flex;
      flex-direction:column;
      gap:8px
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      font-size:12px;
      border-bottom:1px solid var(--border)
    }
    .summary-row:last-child{
      border-bottom:none;
      padding:16px 0 0;
      border-top:2px solid var(--primary);
      font-weight:800;
      font-size:14px;
      color:var(--primary)
    }
    .summary-label{
      color:var(--text-light);
      font-weight:500
    }
    .summary-value{
      color:var(--text-dark);
      font-weight:600
    }
    .receipt-footer{
      text-align:center;
      margin-top:24px;
      padding-top:20px;
      border-top:1px solid var(--border);
      color:var(--text-light);
      font-size:11px;
      line-height:1.6
    }
    .receipt-footer strong{
      color:var(--text-dark)
    }
    .receipt-actions{
      background:#fff;
      border-radius:12px;
      border:1px solid var(--border);
      padding:24px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      position:sticky;
      top:100px
    }
    .action-title{
      color:var(--primary);
      font-weight:700;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:1px;
      margin-bottom:16px;
      display:block
    }
    .action-btn{
      width:100%;
      padding:14px 16px;
      border:none;
      border-radius:8px;
      font-weight:700;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      cursor:pointer;
      transition:all 0.3s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-bottom:12px
    }
    .action-btn:last-child{
      margin-bottom:0
    }
    .btn-download{
      background:var(--primary);
      color:#fff
    }
    .btn-download:hover{
      background:var(--hover);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(211,47,47,0.3)
    }
    .btn-email{
      background:#fff;
      color:var(--text-dark);
      border:2px solid var(--border)
    }
    .btn-email:hover{
      border-color:var(--primary);
      color:var(--primary)
    }
    .btn-print{
      background:#fff;
      color:var(--text-dark);
      border:2px solid var(--border)
    }
    .btn-print:hover{
      border-color:var(--primary);
      color:var(--primary)
    }
    .info-box{
      background:rgba(76,175,80,0.1);
      border:1px solid rgba(76,175,80,0.3);
      border-radius:8px;
      padding:16px;
      margin-top:16px;
      font-size:12px;
      color:var(--text-light);
      line-height:1.6
    }
    .info-box strong{
      color:var(--success)
    }
    @media(max-width:768px){
      .receipt-grid{
        grid-template-columns:1fr;
        gap:24px
      }
      .receipt-actions{
        position:static;
        top:auto
      }
      .receipt-document{
        padding:20px
      }
      .receipt-info{
        grid-template-columns:1fr
      }
      h1{ font-size:24px }
    }
    @media print{
      body{background:#fff}
      header,.receipt-actions{display:none}
      .receipt-document{box-shadow:none;border:none;padding:0}
    }
  </style>
</head>
<body>
  <header>
    <div class="container d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="B-09ConstruccionPedido.html">üåÆ El Mariachi</a>
      <a href="B-12HistorialPedidos.html" class="back-btn">‚Üê Mis Pedidos</a>
    </div>
  </header>

  <main class="container">
    <h1>Boleta Digital</h1>

    <div class="receipt-grid">
      <section class="receipt-document" id="receiptContent">
        <!-- rellenado por JS -->
      </section>

      <aside class="receipt-actions">
        <span class="action-title">Acciones</span>
        <button id="downloadBtn" class="action-btn btn-download">üì• Descargar PDF</button>
        <button id="printBtn" class="action-btn btn-print">üñ®Ô∏è Imprimir</button>
        <button id="emailBtn" class="action-btn btn-email">üìß Reenviar Email</button>

        <div class="info-box">
          <strong>‚úì Boleta Digital</strong><br>
          Esta boleta es v√°lida como comprobante de compra. Se ha enviado una copia a tu email.
        </div>
      </aside>
    </div>
  </main>

<script>
  const order = JSON.parse(sessionStorage.getItem('order') || '{}');
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

  function renderReceipt(){
    if(!order.id){
      document.getElementById('receiptContent').innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--text-light)">
          <div style="font-size:48px;margin-bottom:16px">üìã</div>
          <h4>No hay boleta para mostrar</h4>
          <p>Parece que no tienes un pedido reciente.</p>
          <a href="B-12HistorialPedidos.html" style="display:inline-block;margin-top:16px;background:var(--primary);color:#fff;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:600">Ver mis pedidos</a>
        </div>
      `;
      return;
    }

    const keys = Object.keys(order.cart || {}).filter(k => !k.startsWith('_'));
    let itemsHtml = '';
    keys.forEach(id => {
      const item = order.cart[id];
      const total = item.qty * item.price;
      itemsHtml += `
        <div class="receipt-item-row">
          <div class="item-desc">
            <div class="item-name">${item.name}</div>
            <div class="item-qty">Cantidad: ${item.qty} √ó $${item.price.toLocaleString()}</div>
          </div>
          <div class="item-price">$${total.toLocaleString()}</div>
        </div>
      `;
    });

    const receiptDate = new Date(order.createdAt || Date.now());
    const rut = currentUser.rut || '12.345.678-9';
    const email = currentUser.email || 'usuario@email.com';

    document.getElementById('receiptContent').innerHTML = `
      <div class="receipt-header">
        <div class="receipt-logo">üåÆ</div>
        <div class="receipt-title">El Mariachi</div>
        <div class="receipt-subtitle">Boleta Digital</div>
      </div>

      <div class="receipt-info">
        <div class="info-item">
          <span class="info-label">N√∫mero de Boleta</span>
          <span class="info-value">#${order.id}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Fecha</span>
          <span class="info-value">${receiptDate.toLocaleDateString('es-CL')}</span>
        </div>
        <div class="info-item">
          <span class="info-label">RUT Cliente</span>
          <span class="info-value">${rut}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Email</span>
          <span class="info-value" style="font-size:12px">${email}</span>
        </div>
      </div>

      <div class="receipt-items">
        ${itemsHtml}
      </div>

      <div class="receipt-summary">
        <div class="summary-row">
          <span class="summary-label">Subtotal</span>
          <span class="summary-value">$${order.subtotal.toLocaleString()}</span>
        </div>
        ${order.shipping > 0 ? `
        <div class="summary-row">
          <span class="summary-label">Env√≠o</span>
          <span class="summary-value">$${order.shipping.toLocaleString()}</span>
        </div>
        ` : ''}
        ${order.discount > 0 ? `
        <div class="summary-row">
          <span class="summary-label">Descuento</span>
          <span class="summary-value" style="color:var(--success)">-$${order.discount.toLocaleString()}</span>
        </div>
        ` : ''}
        <div class="summary-row">
          <span>Total</span>
          <span>$${order.total.toLocaleString()}</span>
        </div>
      </div>

      <div class="receipt-footer">
        <strong>Gracias por tu compra</strong><br>
        El Mariachi ‚Ä¢ Comida Mexicana Aut√©ntica<br>
        www.elmariachi.cl<br>
        <br>
        Boleta electr√≥nica generada el ${receiptDate.toLocaleString('es-CL')}<br>
        Esta boleta es v√°lida como comprobante de compra
      </div>
    `;
  }

  document.getElementById('downloadBtn').addEventListener('click', () => {
    // Simulaci√≥n: en producci√≥n usar library como html2pdf o generar PDF en backend
    alert(`Descargando boleta-${order.id}.pdf`);
    // Alternativa simple: usar window.print() despu√©s de preparar el documento
  });

  document.getElementById('printBtn').addEventListener('click', () => {
    window.print();
  });

  document.getElementById('emailBtn').addEventListener('click', () => {
    const email = currentUser.email || 'usuario@email.com';
    alert(`Boleta reenviada a ${email}`);
    // En producci√≥n: fetch(`/api/receipts/${order.id}/resend`, { method:'POST' })
  });

  renderReceipt();
</script>

</body>
</html>
