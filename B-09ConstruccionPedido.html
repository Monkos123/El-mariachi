<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo ‚Ä¢ El Mariachi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#d32f2f;
      --secondary:#ffc107;
      --accent:#ff6f00;
      --dark:#1a1a1a;
      --light:#f5f5f5;
      --text-dark:#212121;
      --text-light:#757575;
      --border:#e0e0e0;
      --success:#4caf50;
      --hover:#b71c1c
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      background:var(--light);
      color:var(--text-dark);
      font-family:'Segoe UI',Roboto,'Helvetica Neue',sans-serif;
      line-height:1.6
    }
    header{
      background:linear-gradient(135deg,var(--primary),var(--hover));
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:16px 0;
      position:sticky;
      top:0;
      z-index:100
    }
    .navbar-brand{
      color:#fff!important;
      font-weight:700;
      font-size:24px;
      letter-spacing:-0.5px
    }
    .nav-actions{
      display:flex;
      gap:12px;
      align-items:center
    }
    .nav-btn{
      padding:8px 16px;
      border:2px solid transparent;
      background:rgba(255,255,255,0.1);
      color:#fff;
      border-radius:8px;
      font-weight:600;
      font-size:12px;
      text-decoration:none;
      cursor:pointer;
      transition:all 0.3s;
      text-transform:uppercase;
      letter-spacing:0.5px
    }
    .nav-btn:hover{
      background:rgba(255,255,255,0.2);
      color:#fff
    }
    .nav-badge{
      background:var(--secondary);
      color:var(--dark);
      padding:4px 8px;
      border-radius:4px;
      font-weight:700;
      font-size:11px;
      margin-left:4px;
      display:inline-block;
    }
    .container{
      max-width:1400px;
      padding:40px 24px
    }
    h1{
      color:var(--text-dark);
      font-weight:700;
      font-size:32px;
      margin-bottom:32px;
      letter-spacing:-0.5px
    }
    .controls{
      display:flex;
      gap:16px;
      margin-bottom:32px;
      align-items:center;
      flex-wrap:wrap
    }
    .search-box{
      flex:1;
      min-width:250px
    }
    .search-box input{
      width:100%;
      padding:10px 16px;
      border:2px solid var(--border);
      border-radius:8px;
      font-size:13px;
      transition:all 0.3s
    }
    .search-box input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(211,47,47,0.1)
    }
    .view-btn{
      padding:10px 16px;
      border:2px solid var(--border);
      background:#fff;
      color:var(--text-dark);
      border-radius:8px;
      font-weight:600;
      font-size:12px;
      cursor:pointer;
      transition:all 0.3s
    }
    .view-btn:hover{
      border-color:var(--primary);
      color:var(--primary)
    }
    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:24px;
      margin-bottom:40px
    }
    .product-card{
      background:#fff;
      border-radius:12px;
      border:1px solid var(--border);
      overflow:hidden;
      transition:all 0.3s;
      display:flex;
      flex-direction:column
    }
    .product-card:hover{
      transform:translateY(-8px);
      box-shadow:0 12px 24px rgba(0,0,0,0.12);
      border-color:var(--primary)
    }
    .product-image{
      width:100%;
      height:180px;
      background:linear-gradient(135deg,#fff,#f1f1f1);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:72px
    }
    .product-content{
      padding:16px;
      flex:1;
      display:flex;
      flex-direction:column
    }
    .product-category{
      color:var(--text-light);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px
    }
    .product-name{
      color:var(--text-dark);
      font-weight:700;
      font-size:14px;
      margin-bottom:8px;
      line-height:1.3
    }
    .product-desc{
      color:var(--text-light);
      font-size:12px;
      margin-bottom:12px;
      flex:1
    }
    .product-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid var(--border)
    }
    .product-price{
      color:var(--primary);
      font-weight:800;
      font-size:16px
    }
    .product-btn{
      padding:8px 12px;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:6px;
      font-weight:600;
      font-size:11px;
      cursor:pointer;
      transition:all 0.3s;
      text-transform:uppercase;
      letter-spacing:0.5px
    }
    .product-btn:hover{
      background:var(--hover);
      transform:translateY(-2px)
    }
    .empty-state{
      text-align:center;
      padding:60px 20px;
      color:var(--text-light)
    }
    .empty-icon{
      font-size:64px;
      margin-bottom:16px
    }
    .modal{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:16px;
    }
    .modal.active{
      display:flex;
    }
    .modal-content-auth{
      background:#fff;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      width:100%;
      max-width:420px;
      overflow:hidden;
    }
    .auth-header{
      background:linear-gradient(135deg,var(--primary),var(--hover));
      color:#fff;
      padding:24px;
      text-align:center;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .auth-header h2{
      margin:0;
      font-size:24px;
      font-weight:800;
      letter-spacing:-0.5px;
    }
    .auth-close{
      position:absolute;
      right:16px;
      top:16px;
      background:rgba(255,255,255,0.2);
      border:none;
      color:#fff;
      font-size:28px;
      cursor:pointer;
      width:40px;
      height:40px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.3s;
    }
    .auth-close:hover{
      background:rgba(255,255,255,0.3);
      transform:rotate(90deg);
    }
    .auth-tabs{
      display:flex;
      gap:0;
      border-bottom:2px solid var(--border);
      background:#f9f9f9;
      padding:0;
    }
    .auth-tab{
      flex:1;
      background:none;
      border:none;
      padding:16px;
      font-weight:700;
      font-size:13px;
      color:var(--text-light);
      cursor:pointer;
      border-bottom:3px solid transparent;
      transition:all 0.3s;
      text-transform:uppercase;
      letter-spacing:0.5px;
      position:relative;
      bottom:-2px;
      text-align:center;
    }
    .auth-tab.active{
      color:var(--primary);
      border-bottom-color:var(--primary);
      background:#fff;
    }
    .auth-tab:hover{
      color:var(--primary);
    }
    .auth-tab-content{
      display:none;
    }
    .auth-tab-content.active{
      display:block;
    }
    .auth-form{
      padding:24px;
    }
    .form-group{
      margin-bottom:16px;
    }
    .form-label{
      display:block;
      color:var(--text-dark);
      font-weight:700;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:8px;
    }
    .form-control{
      width:100%;
      padding:12px 16px;
      border:2px solid var(--border);
      border-radius:8px;
      font-size:14px;
      font-family:inherit;
      transition:all 0.3s;
    }
    .form-control:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(211,47,47,0.1);
    }
    .btn-auth-primary{
      padding:14px;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      font-weight:700;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      cursor:pointer;
      transition:all 0.3s;
    }
    .btn-auth-primary:hover{
      background:var(--hover);
      transform:translateY(-2px);
      box-shadow:0 8px 16px rgba(211,47,47,0.3);
    }
    @media(max-width:768px){
      .products-grid{
        grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
        gap:16px
      }
      .controls{
        flex-direction:column;
        align-items:stretch
      }
      .search-box{
        min-width:100%
      }
      h1{ font-size:24px }
    }
  </style>
</head>
<body>
  <header>
    <div class="container d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="B-09ConstruccionPedido.html">üåÆ El Mariachi</a>
      <div class="nav-actions">
        <a id="navCart" class="nav-btn" href="B-10CarritoCalculo.html">
          üõí CARRITO
          <span class="nav-badge" id="cartBadge" style="display:none">0</span>
        </a>
        <div id="loggedInNav" style="display:none;gap:16px">
          <a id="navOrders" class="nav-btn" href="B-12HistorialPedidos.html">
            üìã MIS PEDIDOS
          </a>
          <span class="nav-btn" style="background:transparent;cursor:default;color:#fff" id="userDisplay"></span>
          <button class="nav-btn" onclick="logoutUser()">üö™ SALIR</button>
        </div>
        <button id="authBtn" class="nav-btn" onclick="openAuthModal()">
          INICIAR SESI√ìN
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Cat√°logo de Productos</h1>

    <div class="controls">
      <div class="search-box">
        <input id="searchInput" type="text" placeholder="Buscar productos...">
      </div>
      <a class="view-btn" href="B-04VisualizacionCatalogo.html">üìã Vista Tabla</a>
      <a class="view-btn" href="B-05BusquedayFiltros.html">üîç Filtros Avanzados</a>
    </div>

    <div class="products-grid" id="productsGrid"></div>
  </main>

  <!-- Modal: Login/Registro -->
  <div id="authModal" class="modal">
    <div class="modal-content-auth">
      <div class="auth-header">
        <h2>El Mariachi</h2>
        <button onclick="closeAuthModal()" class="auth-close">‚úï</button>
      </div>
      
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('login')">Ingresar</button>
        <button class="auth-tab" onclick="switchTab('register')">Registrarse</button>
      </div>

      <!-- Tab Login -->
      <div id="loginTab" class="auth-tab-content active">
        <form id="loginForm" onsubmit="login(event)" class="auth-form">
          <div class="form-group">
            <label for="email" class="form-label">EMAIL</label>
            <input id="email" type="email" class="form-control" placeholder="tu@email.com" required>
          </div>

          <div class="form-group">
            <label for="pass" class="form-label">CONTRASE√ëA</label>
            <input id="pass" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>

          <button type="submit" class="btn-auth-primary w-100">INICIAR SESI√ìN</button>
        </form>
      </div>

      <!-- Tab Register -->
      <div id="registerTab" class="auth-tab-content">
        <form id="registerForm" onsubmit="registro(event)" class="auth-form">
          <div class="form-group">
            <label for="regName" class="form-label">NOMBRE COMPLETO</label>
            <input id="regName" type="text" class="form-control" placeholder="Juan P√©rez" required>
          </div>

          <div class="form-group">
            <label for="regEmail" class="form-label">EMAIL</label>
            <input id="regEmail" type="email" class="form-control" placeholder="tu@email.com" required>
          </div>

          <div class="form-group">
            <label for="regPhone" class="form-label">TEL√âFONO</label>
            <input id="regPhone" type="tel" class="form-control" placeholder="+56 9 1234 5678" required>
          </div>

          <div class="form-group">
            <label for="regPass" class="form-label">CONTRASE√ëA</label>
            <input id="regPass" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>

          <button type="submit" class="btn-auth-primary w-100">REGISTRARSE</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Error -->
  <div id="modalError" class="modal">
    <div class="modal-content-auth">
      <div class="auth-header">
        <h2>Error de Login</h2>
        <button onclick="cerrarModal('modalError')" class="auth-close">‚úï</button>
      </div>
      <div class="auth-form" style="text-align:center;padding:40px 24px">
        <div style="font-size:48px;margin-bottom:16px">‚ùå</div>
        <h3 style="color:var(--text-dark);margin-bottom:8px;font-weight:700">Credenciales Inv√°lidas</h3>
        <p style="color:var(--text-light);margin-bottom:24px">Email o contrase√±a incorrectos. Intenta de nuevo.</p>
        <button class="btn-auth-primary w-100" onclick="cerrarModal('modalError')">Intentar de Nuevo</button>
      </div>
    </div>
  </div>

  <!-- Modal: √âxito Login -->
  <div id="modalExito" class="modal">
    <div class="modal-content-auth">
      <div class="auth-header">
        <h2>¬°Bienvenido!</h2>
        <button onclick="cerrarModal('modalExito')" class="auth-close">‚úï</button>
      </div>
      <div class="auth-form" style="text-align:center;padding:40px 24px">
        <div style="font-size:48px;margin-bottom:16px">‚úÖ</div>
        <h3 style="color:var(--text-dark);margin-bottom:8px;font-weight:700">Sesi√≥n iniciada correctamente</h3>
        <p style="color:var(--text-light);margin-bottom:24px">Tu cuenta ha sido verificada.</p>
        <button class="btn-auth-primary w-100" onclick="continuarDespuesLogin()">Continuar Comprando</button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "http://localhost:4000/graphql";
  let productsList = [];
  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

  function checkAuth(){
    currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    
    if(currentUser && currentUser.id){
      // Usuario logueado
      document.getElementById('authBtn').style.display = 'none';
      document.getElementById('loggedInNav').style.display = 'flex';
      document.getElementById('userDisplay').textContent = `üë§ ${currentUser.fullName || currentUser.email}`;
    } else {
      // Sin sesi√≥n
      document.getElementById('authBtn').style.display = 'block';
      document.getElementById('loggedInNav').style.display = 'none';
    }
    updateCartBadge();
  }

  function updateCartBadge(){
    const cart = JSON.parse(sessionStorage.getItem('cart') || '{}');
    const itemCount = Object.keys(cart).filter(k => !k.startsWith('_')).length;
    const badge = document.getElementById('cartBadge');
    if(itemCount > 0){
      badge.textContent = itemCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  function logoutUser(){
    if(confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')){
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userOrders');
      localStorage.removeItem('userAddresses');
      localStorage.removeItem('userCards');
      currentUser = null;
      checkAuth();
      alert('Sesi√≥n cerrada correctamente');
      location.reload();
    }
  }

  // Login
  document.getElementById('loginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    // Simulaci√≥n: en producci√≥n usar GraphQL mutation
    const user = {
      id: 'user-' + Date.now(),
      name: email.split('@')[0],
      email: email,
      rut: '12.345.678-9'
    };
    localStorage.setItem('currentUser', JSON.stringify(user));
    currentUser = user;
    checkAuth();
    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
    document.getElementById('loginForm').reset();
  });

  // Register
  document.getElementById('registerForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const user = {
      id: 'user-' + Date.now(),
      name: document.getElementById('regName').value,
      email: document.getElementById('regEmail').value,
      rut: document.getElementById('regRut').value
    };
    localStorage.setItem('currentUser', JSON.stringify(user));
    currentUser = user;
    checkAuth();
    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
    document.getElementById('registerForm').reset();
  });

  // Cargar productos
  async function cargarProductos(){
    const query = `
      query {
        productos {
          id_producto
          nombre
          precio
          disponible
          categoria
          descripcion
        }
      }
    `;
    try {
      const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query}) });
      const json = await res.json();
      productsList = (json.data?.productos || []).map(p => ({
        id: String(p.id_producto),
        nombre: p.nombre,
        precio: Number(p.precio) || 0,
        disponible: !!p.disponible,
        categoria: p.categoria || 'Sin categor√≠a',
        descripcion: p.descripcion || ''
      }));
      renderProducts();
    } catch(err){
      console.error(err);
    }
  }

  function renderProducts(){
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    const filtered = productsList.filter(p => 
      !(p.nombre||'').toLowerCase().includes('trabajando para usted') &&
      (!(search) || (p.nombre||'').toLowerCase().includes(search) || (p.descripcion||'').toLowerCase().includes(search))
    );

    if(filtered.length === 0){
      document.getElementById('productsGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üîç</div><h4>Sin resultados</h4><p>No encontramos productos que coincidan</p></div>';
      return;
    }

    document.getElementById('productsGrid').innerHTML = filtered.map(p => `
      <div class="product-card">
        <div class="product-image">üåÆ</div>
        <div class="product-content">
          <div class="product-category">${p.categoria}</div>
          <div class="product-name">${p.nombre}</div>
          <div class="product-desc">${(p.descripcion || '').substring(0, 60)}...</div>
          <div class="product-footer">
            <div class="product-price">$${p.precio.toLocaleString()}</div>
            <button class="product-btn" onclick="addToCart('${p.id}', '${p.nombre}', ${p.precio})" ${!p.disponible ? 'disabled' : ''}>
              ${p.disponible ? '+ Agregar' : 'Agotado'}
            </button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function addToCart(id, name, price){
    if(!currentUser){
      alert('Debes iniciar sesi√≥n para comprar');
      openAuthModal();
      return;
    }

    const cart = JSON.parse(sessionStorage.getItem('cart') || '{}');
    if(cart[id]){
      cart[id].qty += 1;
    } else {
      cart[id] = { name, price, qty: 1 };
    }
    sessionStorage.setItem('cart', JSON.stringify(cart));
    updateCartBadge();
    alert(`${name} agregado al carrito`);
  }

  document.getElementById('searchInput').addEventListener('input', renderProducts);
  cargarProductos();
  checkAuth();

  function continuarDespuesLogin(){
    cerrarModal('modalExito');
    closeAuthModal();
    location.reload();
  }

  function cerrarModal(id){
    document.getElementById(id).classList.remove('active');
  }

  function closeAuthModal(){
    document.getElementById('authModal').classList.remove('active');
  }

  function openAuthModal(){
    document.getElementById('authModal').classList.add('active');
  }

  function switchTab(tab){
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
  }

  function login(e){
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value;

    if(!email || !pass){
      alert('Completa todos los campos');
      return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const found = users.find(u => u.email === email && u.password === btoa(pass));

    if(!found){
      document.getElementById('modalError').classList.add('active');
      document.getElementById('email').value = '';
      document.getElementById('pass').value = '';
      return;
    }

    localStorage.setItem('currentUser', JSON.stringify({
      id: found.id,
      fullName: found.fullName,
      email: found.email,
      phone: found.phone
    }));

    localStorage.setItem('userOrders', JSON.stringify(found.orders || []));
    localStorage.setItem('userAddresses', JSON.stringify(found.addresses || []));
    localStorage.setItem('userCards', JSON.stringify(found.cards || []));
    localStorage.setItem('cart', JSON.stringify(found.cart || {}));

    document.getElementById('loginForm').reset();
    document.getElementById('modalExito').classList.add('active');
  }

  function registro(e){
    e.preventDefault();
    const fullName = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const pass = document.getElementById('regPass').value;

    if(!fullName || !email || !phone || !pass){
      alert('Completa todos los campos');
      return;
    }

    if(fullName.length < 3){
      alert('El nombre debe tener al menos 3 caracteres');
      return;
    }

    if(!email.includes('@')){
      alert('Email inv√°lido');
      return;
    }

    if(phone.length < 9){
      alert('Tel√©fono inv√°lido');
      return;
    }

    if(pass.length < 6){
      alert('La contrase√±a debe tener al menos 6 caracteres');
      return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    if(users.find(u => u.email === email)){
      alert('Este email ya est√° registrado');
      return;
    }

    const newUser = {
      id: `USER-${Date.now()}`,
      fullName,
      email,
      password: btoa(pass),
      phone,
      registeredAt: new Date().toISOString(),
      cart: {},
      orders: [],
      addresses: [],
      cards: []
    };

    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));

    localStorage.setItem('currentUser', JSON.stringify({
      id: newUser.id,
      fullName: newUser.fullName,
      email: newUser.email,
      phone: newUser.phone
    }));

    localStorage.setItem('userOrders', JSON.stringify([]));
    localStorage.setItem('userAddresses', JSON.stringify([]));
    localStorage.setItem('userCards', JSON.stringify([]));
    localStorage.setItem('cart', JSON.stringify({}));

    document.getElementById('registerForm').reset();
    document.getElementById('modalExito').classList.add('active');
  }

  /**
   * Llamar cuando el pago quede aprobado por la pasarela.
   * orderData: { id, total, items:[{id,name,price,qty}], fecha: ISOString, ... }
   * Opcional: si la pasarela devuelve datos de la orden p√°salos aqu√≠.
   */
  function paymentApproved(orderData = {}) {
    // obtener carrito en sesi√≥n
    const cart = JSON.parse(sessionStorage.getItem('cart') || '{}');
    const itemIds = Object.keys(cart);
    if (itemIds.length === 0) {
      // ya est√° vac√≠o
      updateCartBadge();
      return;
    }

    // crear objeto de orden si no se pas√≥
    const order = {
      id: orderData.id || `ORD-${Date.now()}`,
      fecha: orderData.fecha || new Date().toISOString(),
      total: orderData.total || Object.values(cart).reduce((s, it) => s + (it.price * it.qty), 0),
      items: orderData.items || itemIds.map(id => ({ id, name: cart[id].name, price: cart[id].price, qty: cart[id].qty })),
      meta: orderData.meta || {}
    };

    // Si hay usuario logueado: guardar orden en su historial y limpiar su cart guardado
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (currentUser && currentUser.id) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const idx = users.findIndex(u => u.id === currentUser.id);
      if (idx !== -1) {
        users[idx].orders = users[idx].orders || [];
        users[idx].orders.push(order);
        users[idx].cart = {}; // limpiar carrito persistente del usuario
        localStorage.setItem('users', JSON.stringify(users));
      }
      // actualizar currentUser en localStorage por si hace falta
      localStorage.setItem('currentUser', JSON.stringify({
        id: currentUser.id,
        fullName: currentUser.fullName,
        email: currentUser.email,
        phone: currentUser.phone
      }));
    }

    // Limpiar carrito de sesi√≥n (y badge)
    sessionStorage.removeItem('cart');
    // Si usas tambi√©n cart en localStorage, limpiarlo:
    try { localStorage.removeItem('cart'); } catch(e){}

    updateCartBadge();

    // Mostrar confirmaci√≥n y redirigir a p√°gina de resumen/orden si quieres
    alert('Pago aprobado. Tu orden ha sido registrada.');
    // opcional: ir a p√°gina de confirmaci√≥n
    // window.location.href = 'B-11ConfirmacionPedido.html?id=' + order.id;
  }

  // Inicializar
  document.addEventListener('DOMContentLoaded', function(){
    checkAuth();
    cargarProductos();
    updateCartBadge();
  });

  // Escuchar cambios de productos desde admin (B-19)
  window.addEventListener('storage', (e) => {
    if (e.key === 'productsUpdated') {
      console.log('Admin actualiz√≥ productos -> refrescando tienda');
      if (typeof cargarProductos === 'function') {
        cargarProductos();
      } else {
        location.reload();
      }
    }
  });
</script>
</body>
</html>
